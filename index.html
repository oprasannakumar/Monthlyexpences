<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Grocery Price Manager</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family: Arial, sans-serif;
  background:#f5f5f5;
  padding:20px;
  display:flex;
  justify-content:center;
}

.container{
  width:100%;
  max-width:460px;
  background:#fff;
  border-radius:8px;
  box-shadow:0 0 10px rgba(0,0,0,.1);
  padding:18px;
}

/* Centered form content */
/* Perfect visual centering */
.form-center{
  width: 92%;
  max-width: 380px;
  margin-left: auto;
  margin-right: auto;
}

/* Inputs centered optically */
input{
  width: 100%;
  height: 38px;
  padding: 8px 10px;
  margin-top: 6px;
  border-radius: 4px;
  border: 1px solid #ccc;
  font-size: 14px;
  box-sizing: border-box;
}

/* Suggestions aligned exactly with inputs */
.form-center .suggestions{
  width: 100%;
}

label{
  font-size:13px;
  font-weight:600;
  margin-top:10px;
  display:block;
}

input{
  width:100%;
  height:38px;
  padding:8px;
  margin-top:6px;
  border-radius:4px;
  border:1px solid #ccc;
  font-size:14px;
}

/* Buttons */
button{
  border:none;
  border-radius:4px;
  cursor:pointer;
  font-size:13px;
}
.primary-btn{
  width:100%;
  height:36px;
  margin-top:10px;
}
.add-item-btn{background:#6f42c1;color:#fff}
.add-dealer-btn{background:#28a745;color:#fff}
.cancel-btn{background:#6c757d;color:#fff}

.edit-btn,
.delete-btn{
  padding:6px 12px;
  font-size:14px;
  height:32px;
}
.edit-btn{background:#007bff;color:#fff}
.delete-btn{background:#dc3545;color:#fff}

/* Suggestions */
.suggestions{
  width:100%;
  border:1px solid #ccc;
  border-top:none;
  max-height:150px;
  overflow-y:auto;
}
.suggestions div{
  padding:8px;
  cursor:pointer;
}
.suggestions div.active,
.suggestions div:hover{
  background:#007bff;
  color:#fff;
}

/* Info boxes */
.info-box{
  margin-top:16px;
  padding:14px;
  background:#e9ecef;
  border-radius:6px;
}

/* Dealer list */
.dealer-row{
  background:#fff;
  padding:10px;
  margin-top:10px;
  border-radius:4px;
  font-size:13px;
  display:flex;
  justify-content:space-between;
  gap:12px;
}
.dealer-info{flex:1}
.dealer-actions{
  display:flex;
  gap:8px;
  align-items:flex-start;
}

.hidden{display:none}
</style>
</head>

<body>

<div class="container">

  <!-- STATUS -->
  <div id="statusMsg" style="text-align:center;font-size:12px;color:#555;"></div>

  <!-- ITEM SEARCH -->
  <div id="itemSearchBox">
    <div class="form-center">
      <label>Item</label>
      <input id="itemInput"
             placeholder="Type or select item..."
             oninput="filterItems()"
             onkeydown="handleItemKeys(event)">
      <div id="itemSuggestions" class="suggestions"></div>
    </div>
  </div>

  <!-- ACTION BUTTONS -->
  <div id="actionButtons" class="form-center">
    <button class="primary-btn add-item-btn" onclick="showAddItem()">‚ûï Add Item</button>
    <button id="addDealerBtn"
            class="primary-btn add-dealer-btn hidden"
            onclick="showAddDealer()">‚ûï Add Dealer</button>
  </div>

  <!-- ADD ITEM -->
  <div id="addItemBox" class="info-box hidden">
    <div class="form-center">
      <label>Item Name</label>
      <input id="newItemName">

      <label>Dealer</label>
      <input id="newItemDealer"
             oninput="filterDealerSuggestions(this,'dealerSug1')"
             onkeydown="handleDealerKeys(event,'dealerSug1',this)">
      <div id="dealerSug1" class="suggestions"></div>

      <label>Price</label>
      <input id="newItemPrice" type="number"
             onkeydown="handlePriceEnter(event,'item')">

      <button class="primary-btn add-item-btn" onclick="addItem()">Save Item</button>
      <button class="primary-btn cancel-btn" onclick="cancelForms()">Cancel</button>
    </div>
  </div>

  <!-- ADD DEALER -->
  <div id="addDealerBox" class="info-box hidden">
    <div class="form-center">
      <label>Dealer</label>
      <input id="dealerName"
             oninput="filterDealerSuggestions(this,'dealerSug2')"
             onkeydown="handleDealerKeys(event,'dealerSug2',this)">
      <div id="dealerSug2" class="suggestions"></div>

      <label>Price</label>
      <input id="dealerPrice" type="number"
             onkeydown="handlePriceEnter(event,'dealer')">

      <button class="primary-btn add-dealer-btn" onclick="addDealer()">Save Dealer</button>
      <button class="primary-btn cancel-btn" onclick="cancelForms()">Cancel</button>
    </div>
  </div>

  <!-- DEALER LIST -->
  <div id="details" class="info-box hidden">
    <div class="form-center">
      <button class="primary-btn delete-btn" onclick="deleteItem()">üóë Delete Item</button>
      <div id="dealerList"></div>
    </div>
  </div>

</div>

<script>
/* -------- JS LOGIC UNCHANGED (WORKING) -------- */
const API_URL="https://script.google.com/macros/s/AKfycbzRt_ad2rXgZNVO4_Nlumm8EAxN7jcG7gG1y0yKEec7WXnws68ygcAqrhCjRzcmdWzl/exec";
const API_KEY="9848o22338B!";

let groceries={},selectedItem="";
let filteredItems=[],itemIndex=-1;
let dealerIndex={};

window.onload=()=>fetch(`${API_URL}?key=${API_KEY}`).then(r=>r.json()).then(d=>groceries=d||{});

function handlePriceEnter(e,type){ if(e.key==="Enter"){ e.preventDefault(); type==="item"?addItem():addDealer(); } }
function showStatus(m){statusMsg.textContent=m;}
function clearStatus(){setTimeout(()=>statusMsg.textContent="",1500);}
function save(p,cb){showStatus("Saving...");fetch(API_URL,{method:"POST",body:JSON.stringify({...p,key:API_KEY})}).then(()=>clearStatus());cb();}

function filterItems(){
  const v=itemInput.value.toLowerCase();
  itemSuggestions.innerHTML=""; filteredItems=[]; itemIndex=-1;
  if(!v) return;
  filteredItems=Object.keys(groceries).filter(i=>i.toLowerCase().includes(v));
  filteredItems.forEach(i=>{
    const d=document.createElement("div");
    d.textContent=i; d.onclick=()=>selectItem(i);
    itemSuggestions.appendChild(d);
  });
}
function handleItemKeys(e){
  if(!filteredItems.length) return;
  if(e.key==="ArrowDown"){e.preventDefault();itemIndex=(itemIndex+1)%filteredItems.length;highlight(itemSuggestions,itemIndex);}
  else if(e.key==="ArrowUp"){e.preventDefault();itemIndex=(itemIndex-1+filteredItems.length)%filteredItems.length;highlight(itemSuggestions,itemIndex);}
  else if(e.key==="Enter"){e.preventDefault();selectItem(filteredItems[itemIndex===-1?0:itemIndex]);}
}
function getAllDealers(){
  const s=new Set();
  Object.values(groceries).forEach(a=>a.forEach(d=>s.add(d.dealer)));
  return [...s];
}
function filterDealerSuggestions(input,boxId){
  const v=input.value.toLowerCase(), box=document.getElementById(boxId);
  box.innerHTML=""; dealerIndex[boxId]=-1;
  if(!v) return;
  getAllDealers().filter(d=>d.toLowerCase().includes(v)).forEach(d=>{
    const div=document.createElement("div");
    div.textContent=d; div.onclick=()=>{input.value=d;box.innerHTML="";};
    box.appendChild(div);
  });
}
function handleDealerKeys(e,boxId,input){
  const box=document.getElementById(boxId), items=[...box.children];
  if(!items.length) return;
  if(e.key==="ArrowDown"){e.preventDefault();dealerIndex[boxId]=(dealerIndex[boxId]+1)%items.length;highlight(box,dealerIndex[boxId]);}
  else if(e.key==="ArrowUp"){e.preventDefault();dealerIndex[boxId]=(dealerIndex[boxId]-1+items.length)%items.length;highlight(box,dealerIndex[boxId]);}
  else if(e.key==="Enter"||e.key===" "){e.preventDefault();input.value=items[dealerIndex[boxId]??0].textContent;box.innerHTML="";}
}
function highlight(box,i){ [...box.children].forEach((el,idx)=>el.classList.toggle("active",idx===i)); }

function selectItem(item){
  selectedItem=item; itemInput.value=item; itemSuggestions.innerHTML="";
  details.classList.remove("hidden"); addDealerBtn.classList.remove("hidden");
  dealerList.innerHTML="";
  groceries[item].forEach(d=>{
    dealerList.innerHTML+=`
    <div class="dealer-row">
      <div class="dealer-info">
        <b>${d.dealer}</b> ‚Äì ‚Çπ${d.price}<br>
        Date: ${new Date(d.updated||Date.now()).toLocaleDateString("en-GB")}<br>
        Time: ${new Date(d.updated||Date.now()).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}
      </div>
      <div class="dealer-actions">
        <button class="edit-btn" onclick="editDealer('${d.dealer}',${d.price})">‚úèÔ∏è</button>
        <button class="delete-btn" onclick="deleteDealer('${d.dealer}')">üóë</button>
      </div>
    </div>`;
  });
}

function enterFormMode(){itemSearchBox.classList.add("hidden");actionButtons.classList.add("hidden");details.classList.add("hidden");addDealerBtn.classList.add("hidden");}
function exitFormMode(){itemSearchBox.classList.remove("hidden");actionButtons.classList.remove("hidden");}

function showAddItem(){enterFormMode();addItemBox.classList.remove("hidden");}
function showAddDealer(){enterFormMode();addDealerBox.classList.remove("hidden");}

function addItem(){
  const itemName = newItemName.value.trim();
  const dealer = newItemDealer.value.trim();
  const price = Number(newItemPrice.value);

  if(!itemName || !dealer || isNaN(price)) return;

  // Normalize for comparison
  const itemKey = itemName.toLowerCase();
  const dealerKey = dealer.toLowerCase();

  // Check if item already exists
  const existingItemKey = Object.keys(groceries)
    .find(i => i.toLowerCase() === itemKey);

  // If item exists, check dealer duplication
  if(existingItemKey){
    const dealerExists = groceries[existingItemKey]
      .some(d => d.dealer.toLowerCase() === dealerKey);

    if(dealerExists){
      alert(
        `Item "${existingItemKey}" with dealer "${dealer}" already exists.\n` +
        `Please edit the price instead of adding again.`
      );
      newItemDealer.focus();
      return;
    }
  }

  // ‚úÖ Allowed: new item OR new dealer for existing item
  save(
    {
      action: "add",
      item: itemName,
      dealer,
      price
    },
    () => {
      if(existingItemKey){
        groceries[existingItemKey].push({
          dealer,
          price,
          updated: Date.now()
        });
        cancelForms();
        selectItem(existingItemKey);
      } else {
        groceries[itemName] = [{
          dealer,
          price,
          updated: Date.now()
        }];
        cancelForms();
        selectItem(itemName);
      }
    }
  );
}
function addDealer(){
  const d=dealerName.value,p=Number(dealerPrice.value);
  if(!d||isNaN(p))return;
  save({action:"add",item:selectedItem,dealer:d,price:p},()=>{groceries[selectedItem].push({dealer:d,price:p,updated:Date.now()});cancelForms();selectItem(selectedItem);});
}
function editDealer(dealer,old){
  const p=Number(prompt("New price:",old));
  if(isNaN(p))return;
  save({action:"update",item:selectedItem,dealer,price:p},()=>{groceries[selectedItem].forEach(x=>{if(x.dealer===dealer){x.price=p;x.updated=Date.now();}});selectItem(selectedItem);});
}
function deleteDealer(dealer){
  if(!confirm("Delete dealer?"))return;
  save({action:"delete",item:selectedItem,dealer},()=>{groceries[selectedItem]=groceries[selectedItem].filter(x=>x.dealer!==dealer);selectItem(selectedItem);});
}
function deleteItem(){
  if(!confirm("Delete item?"))return;
  save({action:"deleteItem",item:selectedItem},()=>{delete groceries[selectedItem];selectedItem="";details.classList.add("hidden");addDealerBtn.classList.add("hidden");itemInput.value="";});
}
function cancelForms(){
  addItemBox.classList.add("hidden"); addDealerBox.classList.add("hidden"); exitFormMode();
  newItemName.value=newItemDealer.value=newItemPrice.value=dealerName.value=dealerPrice.value="";
  dealerSug1.innerHTML=""; dealerSug2.innerHTML="";
}
</script>

</body>
</html>
